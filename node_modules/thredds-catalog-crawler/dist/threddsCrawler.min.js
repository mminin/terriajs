!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).threddsCrawler=e()}(this,function(){"use strict";class t{constructor(t,e,a){this.parseUrl=t,this.proxy=e.proxy?e.proxy:null,this.DOMParser=a}async getData(t){t=this.proxy?`${this.proxy}${t}`:t;const e=await fetch(t),a=await e.text();return this.parseStringSync(a)}parseStringSync(t){return function(t,e,a){if(!t)return{};var s=function(t){return String(t||"").replace(/-/g,"_")},r=function(t){return Array.isArray(t)||(t=[t]),t.length=t.length,t};if("string"==typeof t){const e=new a;t=e.parseFromString(t,"text/xml")}if(!t.nodeType)return;if(3===t.nodeType||4===t.nodeType)return t.nodeValue;var l=9===t.nodeType?t.documentElement:t,n=function t(a,l){if(!a)return null;let n="";let i=null;let o=null;if(a.childNodes&&a.childNodes.length>0)for(var h=0;h<a.childNodes.length;++h){const e=a.childNodes[h],l=e.nodeType,o=s(e.localName||e.nodeName),c=e.text||e.nodeValue||"";if(8!==l)if(3!==l&&4!==l&&o)(i=i||{})[o]?(i[o].length||(i[o]=r(i[o])),i[o]=r(i[o]),i[o][i[o].length]=t(e,!0),i[o].length=i[o].length):i[o]=t(e);else{if(c.match(/^\s+$/))continue;n+=c.replace(/^\s+/,"").replace(/\s+$/,"")}}if(a.attributes&&a.attributes.length>0){o={},i=i||{};for(var c=0;c<a.attributes.length;++c){let t=a.attributes[c],e=s(t.name),l=t.value;o[e]=l,i[e]?(i[cnn]=r(i[cnn]),i[e][i[e].length]=l,i[e].length=i[e].length):i[e]=l}}if(i){var u=""!==n?new String(n):{};for(var d in i)i.hasOwnProperty(d)&&(u[d]=i[d]);(n=(i=u).text?[i.text||""].concat([n]):n)&&(i.text=n),n=""}var g=i||n;e&&(n&&(g={}),(n=g.text||n||"")&&(g.text=n),l||(g=r(g)));return g}(l,!0);return t=null,l=null,n}(t,!1,this.DOMParser)}}function e(t){return new URL(t)}class a{constructor(t,e){this.parent=e,this.id=t.ID,this.name=t.name,this.urlPath=t.urlPath?t.urlPath:null,this.dataType=t.dataType?t.dataType:null,this.dataFormat=t.dataFormat?t.dataFormat:null,t.dataSize?this.dataSize={size:t.dataSize["#text"],unit:t.dataSize.$units}:this.dataSize=null,t.date?this.date={size:t.date["#text"],type:t.date.$type}:this.date=null,this.isParentDataset=null===this.dataSize,this.datasets=[],this._datasetJson=t,this.catalogsAreLoaded=!1,this.catalogs=[]}async getNestedDatasets(){const t=this._datasetJson;if(t.dataset){Array.isArray(t.dataset)||(t.dataset=[t.dataset]);for(let e=0;e<t.dataset.length;e++){const s=new a(t.dataset[e],this);await s.getNestedDatasets(),this.datasets.push(s)}}}async loadAllNestedCatalogs(){const t=this._datasetJson;if(t.catalogRef){Array.isArray(t.catalogRef)||(t.catalogRef=[t.catalogRef]);for(let e=0;e<t.catalogRef.length;e++){const a=this._cleanUrl(t.catalogRef[e]["xlink:href"]);try{const s=new r(a,t.catalogRef[e],this,this.parent._requestor);await s._loadCatalog(),this.catalogs.push(s)}catch(t){console.error(`Couldn't create catalog within dataset:\n                        Dataset URL: ${a}\n                        ${t}`)}}}this.catalogsAreLoaded=!0}_cleanUrl(t){return t.indexOf("://")>=0?t:`${this.parentCatalog._catalogBaseUrl}${t}`}get wmsUrl(){return this.supportsWms?`${this.parentCatalog.wmsBase}${this.urlPath}?service=WMS&version=1.3.0&request=GetCapabilities`:null}get ncssUrl(){return this.supportsNcss?`${this.parentCatalog.ncssBase}${this.urlPath}`:null}get parentCatalog(){const t=this.parent;return t.isParentDataset?t.parent:t}get supportsWms(){return!this.isParentDataset&&this.parentCatalog.supportsWms}get supportsNcss(){return!this.isParentDataset&&this.parentCatalog.supportsNcss}}class s{constructor(t){this.name=t.name,this.type=t.serviceType,this.baseUrl=t.base}}class r{constructor(t,e,a,s){this.url=t,this.name=null!==e?e.name:null,this.title=null!==e?e["xlink:title"]:null,this.id=null!==e?e.ID:null,this.isLoaded=!1,this.datasets=[],this.catalogs=[],this.services={},this.parentCatalog=a,this._catalogJson=e,this._requestor=s,this._urlObj=s.parseUrl(this.url),this._catalogBaseUrl=this.url.replace("catalog.xml",""),this._rootUrl=`${this._urlObj.protocol}//${this._urlObj.host}`}get hasDatasets(){return"dataset"in this._catalogJson}get hasNestedCatalogs(){return"catalogRef"in this._catalogJson}get supportsNcss(){return"subsetServer"in this.services}get ncssBase(){return this.supportsNcss?`${this._rootUrl}${this.services.subsetServer.baseUrl}`:null}get supportsWms(){return"wms"in this.services}get wmsBase(){return this.supportsWms?`${this._rootUrl}${this.services.wms.baseUrl}`:null}async _loadCatalog(){this._catalogJson=await this._requestor.getData(this.url),this.isLoaded=!0,await this._processCatalog()}async _processCatalog(){const t=this._catalogJson;if(null!==this.name&&""!==this.name||(this.name=t.name),null!==this.title&&""!==this.title||(this.title=t["xlink:title"]),null===this.id&&(this.id=t.ID),t.dataset){Array.isArray(t.dataset)||(t.dataset=[t.dataset]);for(var e=0;e<t.dataset.length;e++){const s=new a(t.dataset[e],this);await s.getNestedDatasets(),this.datasets.push(s)}}if(t.service&&this._getServicesRecursively(t.service),t.catalogRef){Array.isArray(t.catalogRef)||(t.catalogRef=[t.catalogRef]);for(let e=0;e<t.catalogRef.length;e++){const a=this._cleanUrl(t.catalogRef[e]["xlink:href"]);try{const s=new r(a,t.catalogRef[e],this,this._requestor);this.catalogs.push(s)}catch(t){console.error(`\n                        Couldn't create catalog in catalog: ${a}\n                        Parent was: ${this.url}\n                        ${t}`)}}}}async loadAllNestedCatalogs(){for(let t=0;t<this.catalogs.length;t++){const e=this.catalogs[t];try{await e._loadCatalog(),await e.loadAllNestedCatalogs()}catch(t){console.error(`\n                    Couldn't create catalog in catalog: ${e.url}\n                    Parent was: ${this.url}\n                    ${t}`)}}}async loadNestedCatalogById(t){let e=!1;for(let a=0;a<this.catalogs.length;a++){const s=this.catalogs[a];if(s.id===t){e=!0;try{return await s._loadCatalog(),s}catch(t){console.error(`\n                    Couldn't create catalog in catalog: ${s.url}\n                    Parent was: ${this.url}\n                    ${t}`)}}}if(!e)throw new Error(`Could not find catalog using id: ${t}`)}_getServicesRecursively(t){Array.isArray(t)&&(t=t[0]);for(let e=0;e<t.service.length;e++){const a=t.service[e];if("service"in a)this._getServicesRecursively(a);else{const t=new s(a);this.services[t.name]=t}}}_cleanUrl(t){return t.indexOf("://")>=0?t:-1===t.indexOf("thredds")?`${this._catalogBaseUrl}/${t}`:`${this._rootUrl}${t}`}getAllChildDatasets(){let t=[];for(var e=0;e<this.catalogs.length;e++)t=t.concat(this.catalogs[e].getAllChildDatasets());for(let e=0;e<this.datasets.length;e++)if(this.datasets[e].isParentDataset)for(var a=0;a<this.datasets[e].datasets.length;a++)t.push(this.datasets[e].datasets[a]);else t.push(this.datasets[e]);return t}}return async function(a,s){"proxy"in(s=null==s?{}:s)&&(s.proxy="/"===s.proxy.slice(-1)?s.proxy:s.proxy+"/");const l=new t(e,s,DOMParser);return await async function(t,e){const a=new r(t,null,null,e);return await a._loadCatalog(),a}(a,l)}});
